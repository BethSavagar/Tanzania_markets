---
title: "Tanzania Market Survey A: Descriptive Analysis"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)

```

```{r load-data, include = F}

# read in CLEAN tanzania market data (after mrkta_cleaning-script) (tanzania_data file contains original ecopprmarketscsvs filtered to Tanzania data only)

mrkta_clean <-  read_csv("~/OneDrive - Royal Veterinary College/4. tanzania_markets_2/tanzania_data/mrkta_generalinfo_tanzania_CLEAN.csv")

```

## Market Survey A Data: First Look

- Market survey A is the key informant interview. 
- There is one row (survey) per market. 
- The survey mostly contains contextual information that is not useful for my analysis
- Market Survey A should be used as a GPS reference for all markets in market survey C
- Also the number of small ruminants bought and sold at each market. 

*From the EcoPPR Field Guide:*

- Key informant interview with the market manager or other key person who is knowledgeable about the market, focusing on the general characteristics of the market. (1 survey per market)
- At each market, the field team will identify and arrange to meet with the market manager/person in-charge to introduce the project and obtain permission to collect data, and then conduct a short interview
<br>

### 1) What fields are contained in the cleaned survey data?
<br>
a) Raw Data:
```{r raw_fields, echo = F, warning = F}

# Fields contained in market A data:
colnames(mrkta_clean) %>% kable()
```

### 2) How many observations are there?
- How many surveys were completed (i.e. how many markets were visited?)
- NB: Majimoto market had 2 surveys conducted 1 month apart. 

```{r num_mrkts, echo =F, warning=F}
num_mrkt <- nrow(mrkta_clean)
num_mrkt

mrkta_clean %>% filter(market.name == "majimoto")
```
- How many surveys were completed in each **region**?
  - NB: first 6 regions were those that were targeted...
  - *Why is the number of surveys so uneven?*
    - DM suggested that the different number of surveys in each region just reflects the different number of markets in those regions (some have many, others have few)

```{r mrkt_region, echo = F, warning = F}

mrktregion_count <- mrkta_clean %>% group_by(district.region.name) %>% count() %>% 
  mutate("target" = ifelse(`district.region.name` %in% c("katavi", "simiyu", "mbeya", "mtwara", "morogoro", "dodoma"), "target","no_target")) %>%
  mutate(target = ordered(target, levels = c("target", "no_target"))) %>%
  arrange(target)

mrktregion_count %>% 
  select(district.region.name, target, n) %>% 
  kable()

ggplot(mrktregion_count, aes(x = district.region.name, y=n))+
  geom_bar(stat = "identity", 
           aes(fill = target,
               #color = target,
               ), alpha = 0.75)+
  #scale_color_brewer(palette = "Set1", direction = -1)+
  scale_fill_brewer(palette = "Set1", direction = -1)+
  labs(x="Region", y = "Number of Surveys", fill = "Target")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))



```
<br>

### 4) How many markets per village?
- A village is the smallest administrative level included in the survey, we would expect no more than 1 market per village
- All villages have 1 market (except Majimoto)

```{r market_village, echo = F, warning = F}

mrkta_clean %>% 
  group_by(market.name.corrected) %>% 
  count() %>% 
  filter(n>1) %>%
  nrow()
```

### 4) How many markets per ward?
- A ward is the administrative level above a village, how many markets were surveyed in each Ward?
- In most wards only one market was surveyed
- Below is a list of wards which have more than one market: Mtandi, Majimoto, Mnavira
- NB: Majimoto is the repeat market name entry from above

```{r market_ward, echo = F, warning = F}
# markets by WARD:
# Do any wards have more than 1 market?
duplicate.wards <- mrkta_clean %>% 
  group_by(ward.code) %>% 
  count() %>% 
  filter(n>1) %>%
  pull(ward.code) # most wards are unique to 1 market, 3 wards have more than 1 market.

mrkta_clean %>% filter(ward.code %in% duplicate.wards) %>% select(district.region.code, ward.code, ward.name, village, market.name.corrected) %>% arrange(ward.name) %>% kable()
```

### 5) What is the type of the markets?
- Market type: 
  - *Primary market* - located close to the place of production or rearing of small ruminants, usually located within villages or small towns.
  - *Secondary market* - usually found in suburbs, animals are transported some distance from their place of production/rearing to the market.
  - *Tertiary or final consumption market* - generally located in towns or populated areas to supply urban populations, animals are transported quite a long-distance from their place of production/rearing.

- All markets are given as Type 1: Primary Markets (note the buyer-seller questionnaire is not consistent with this)

```{r market.type, echo = F}

#####################
# markets by TYPE: 
mrkta_clean %>% 
  group_by(market.type) %>% 
  count() %>% kable() # all markets are type 1

```





## Market Maps:

```{r map_data, include = F}

## MAPPING MARKETS ##

# Load Tanzania Shapefile:
tanzania_shp <- st_read(here("shapefiles/Districts and TC as 2020.shp"))

# Convert mrkt_a to sf for mapping

# GPS coordinates of market are in degrees decimal minutes - DDM (i think)

mrkta_map <- mrkta_clean %>%
  select(fid,
         country,
         district.region.code,
         district.region.name,
         ward.code,
         ward.name,
         village,
         market.name,
         market.name.corrected,
         market.type,
         gps.coordinates.of.the.market,                                 
         unique.row.identifier.uuid.
         ) %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])

mrkta_sf <- st_as_sf(mrkta_map, coords = c("long","lat"),  crs = 4326)

# 
# # plot tanzania districts
# ggplot()+
#   geom_sf(data=tanzania_shp)+
#   coord_sf()+
#   theme_bw()
```


### Map of markets colour coded by region
- 6 regions were targeted for surveys
- Regions were targeted purposively as locations where surveys had not previously taken place (not well studied)

Regions Surveyed: 

- NB: this table includes regions where market surveys took place which were not stated as target regions
- Target regions are 1-6

```{r targ_region, echo = F, warning = F}

regions <- data.frame(
  "region" = c(
    "KATAVI",
    "SIMIYU",
    "MBEYA",
    "MTWARA",
    "MOROGOR0",
    "DODOMA",
    "MWANZA",
    "NJOMBE",
    "RUKWA",
    "SONGWE",
    "IRINGA"
  ),
  "target" = c(
    "target",
    "target",
    "target",
    "target",
    "target",
    "target",
    "non_target",
     "non_target",
     "non_target",
     "non_target",
     "non_target"
    ),
  "Location (study site)" = c(
    "West. Mpimbwe district in this region",
    "North. Bariadi is the regional capital.",
    "West/South-West. Mbarali District in this region.",
    "South (South-East). Masasi district in this region",
    "Centre (Centre-East). Ulanga district in this region.",
    "Centre (Centre-East). Bahi district in this region.",
    "North",
    "South (South-West).",
    "East (South-East).",
    "East (South-East).",
    "Centre"
  )
)

regions %>% knitr::kable()
```


```{r tanzania_map, echo = F, warning = F}

# markets by REGION (colour coordinated)
mrktmap_colour <- ggplot() +
  geom_sf(data = tanzania_shp) +
  geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`))) +
  labs(title = "Location of markets, colour by region", col = "District (Region)")+
  # scale_color_brewer(palette = "Set3")+
  coord_sf()+
  theme_bw()

mrktmap_colour
```

### Tanzania Map with *targeted* regions highlighted
- Map of tanzania highlighting regions which were targeted for surveys

```{r region_map_colour, echo = F}

map_col <- brewer.pal(9,"Set1")
map_col[10] <- "#000000"
map_col[11] <- "#FF69B4"
# highlight regions surveyed

districts_surveyed_shp <- tanzania_shp %>%
  # update district names 
  mutate(surveyed = 
           ifelse(NewDist20 == "Mpimbwe DC", "Mpimbwe", 
                  ifelse(NewDist20 == "Bariadi DC", "Bariadi", 
                         ifelse(NewDist20 == "Mbarali DC", "Mbarali",
                                ifelse(NewDist20 == "Masasi DC", "Masasi",
                                       ifelse(NewDist20 == "Ulanga DC", "Ulanga", 
                                              ifelse(NewDist20 == "Bahi DC", "Bahi", NA))))))) %>%
  filter(!is.na(surveyed))


# map with regions surveyed highlighted
region_map <- ggplot()+
  geom_sf(data= tanzania_shp)+
  geom_sf(data= districts_surveyed_shp, aes(fill = surveyed))+
  # labs(title = "Regions targeted for survey")+
  scale_color_manual(palette = map_col)+
  coord_sf()+
  theme_bw()


# map with regions surveyed highlighted and points of market locations superimposed on top
mrkta_sf <- mrkta_sf %>% 
  mutate("target" = ifelse(`district.region.name` %in% c("katavi", "simiyu", "mbeya", "mtwara", "morogoro", "dodoma"), "target","no_target"))

mrktregion_map <- ggplot()+
  geom_sf(data = tanzania_shp, fill = NA)+
  geom_sf(data = districts_surveyed_shp, aes(fill = surveyed), alpha = 0.4)+
  geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`), shape = target))+
  scale_shape_manual(values=c(7,16))+
  # scale_color_brewer(palette = "Set3")+
  coord_sf()+
  labs(col = "District/Region", fill = "Target District")+
  theme_bw()+
  theme(legend.position = "bottom", legend.direction = "vertical", legend.box = "horizontal", )
# 
# mrktregion_map <- ggplot()+
#   geom_sf(data = tanzania_shp)+
#   geom_sf(data = districts_surveyed_shp, aes(fill = surveyed), alpha = 0.5)+
#   geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`)))+
#   scale_color_manual(palette = map_col)+
#   coord_sf()+
#   labs(col = "District/Region", fill = "Target District")+
#   theme_bw()+
#   theme(legend.direction = "vertical", legend.box = "horizontal")
```
```{r region_map, echo = F}
# region_map
```
\newpage

### Regions targeted for market survey + market locations
- Map of Tanzania highlighting regions targeted for survey, and market survey locations (colour coded by region)

```{r mrktregion_map, echo = F}
mrktregion_map
```
\newpage


### Sheep and Goat sales per day
- The total number of sheep and goats sold across all markets
- More goats sold:

```{r tot_sales, echo = F}

# sheep sales per day
# mrkta_clean %>%
#   group_by(`3a.no.sheep.sold.per.day`) %>%
#   count()

sales <- mrkta_clean %>%
  mutate(`3c.all.sold.per.day` = `3a.no.sheep.sold.per.day`+`3b.no.goats.sold.per.day`) %>%
  select(fid, district.region.code, district.region.name, sales = `3c.all.sold.per.day`) %>% mutate(sp = "All") %>%
  rbind(mrkta_clean %>%
  select(fid, district.region.code, district.region.name, sales = `3a.no.sheep.sold.per.day`) %>%
  mutate(sp = "Sheep")) %>%
  rbind(mrkta_clean %>%
    select(fid, district.region.code, district.region.name, sales = `3b.no.goats.sold.per.day`) %>%
  mutate(sp = "Goat"))

# total reported sheep and goat sales per day of market
tot.sales <- sales %>% 
  group_by(sp) %>%
  summarise(tot = sum(sales)) %>%
  rename(Species = sp,
         Total_Sales = tot)

kable(tot.sales)
```

### Reported total sales of sheep and goats per day at surveyed markets
<br>
```{r sales_per_day, echo = F, fig.width = 4, fig.height = 4}
SR_sales_per_day <- ggplot(sales %>% filter(sp=="All"))+
  geom_histogram(aes(x=sales), binwidth = 25, alpha = 0.5, col = "black", boundary = 0)+
  scale_x_continuous(breaks = seq(0,650,50), labels = seq(0,650,50))+
  labs(x = "All Small Ruminant Sales per Day", 
       y = "Count",
       main = "All Small Ruminant Sales per Day")+
  # facet_wrap(~sp)
  theme_bw()

sales_per_day <- ggplot(sales %>% filter(sp %in% c("Sheep", "Goat")))+
  geom_histogram(aes(x=sales,col=sp, fill = sp), binwidth = 25, alpha = 0.5, position = position_dodge(), boundary = 0)+
  scale_x_continuous(breaks = seq(0,400,50), labels = seq(0,400,50))+
  labs(x = "Sheep & Goat Sales per Day", 
       y = "Count",
       fill = "Species", 
       col = "Species",
       main = "Sheep and Goat Sales per Day")+
  # facet_wrap(~sp)
  theme_bw()


shgt_scatter <- ggplot(mrkta_clean, aes(x = `3a.no.sheep.sold.per.day`, 
                                       y = `3b.no.goats.sold.per.day` ))+
  geom_point()+
  labs(x = "Sheep sales per day",
       y = "Goat sales per day")+
  theme_bw()
```

```{r, echo=F}

sales_arr <- ggarrange(SR_sales_per_day,
sales_per_day,
shgt_scatter, ncol = 1)

sales_arr

```
<br>
<br>

### Reported total sales of sheep and goats per day at surveyed markets: BY REGION

```{r regional_sales, echo = F, fig.width = 4, fig.height = 4}
SR_sales_per_day_rg <- ggplot(sales %>% filter(sp=="All"))+
  geom_histogram(aes(x=sales), binwidth = 25, alpha = 0.5, col = "black", boundary = 0)+
  scale_x_continuous(breaks = seq(0,650,50), labels = seq(0,650,50))+
  labs(x = "All Small Ruminant Sales per Day", 
       y = "Count",
       main = "All Small Ruminant Sales per Day")+
  facet_wrap(~`district.region.name`)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))


sales_per_day_rg <- ggplot(sales %>% filter(sp %in% c("Sheep", "Goat")))+
  geom_histogram(aes(x=sales,col=sp, fill = sp), binwidth = 25, alpha = 0.5, position = position_dodge(), boundary = 0)+
  scale_x_continuous(breaks = seq(0,400,50), labels = seq(0,400,50))+
  labs(x = "Sheep & Goat Sales per Day", 
       y = "Count",
       fill = "Species", 
       col = "Species",
       main = "Sheep and Goat Sales per Day")+
  # facet_wrap(~sp)
  facet_wrap(~`district.region.name`)+
  theme_bw()+
    theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))


shgt_scatter_rg <- ggplot(mrkta_clean, aes(x = `3a.no.sheep.sold.per.day`, 
                                       y = `3b.no.goats.sold.per.day` ))+
  geom_point()+
  labs(x = "Sheep sales per day",
       y = "Goat sales per day")+
  facet_wrap(~`district.region.name`)+
  theme_bw()

SR_sales_per_day_rg

sales_per_day_rg
# shgt_scatter_rg

```







*Small Ruminant Sales interpretation*
- ....

### Is there seasonal variation in trade?

```{r seasonal_trade, echo = F}

mrkta_clean %>% 
  group_by(`4.seasonal.variation.in.trade`) %>%
  count() %>%
  mutate(
    YN = ifelse(`4.seasonal.variation.in.trade` == 0, "N", "Y"),
    proportion = n/nrow(mrkta_clean)) %>% 
  select(`4.seasonal.variation.in.trade`, YN, n, proportion) %>%
  kable()
```


For those which state seasonal variation what details are provided?
- *Translate the below*
```{r seasonal_trade_ans, echo = F, warning = F}
# translate this: 
mrkta_clean %>% select(`4.seasonal.variation.in.trade`, `4.if.yes.describe`) %>% head() %>% kable()
```

### What does the market A data look like for locations brought from and to?

```{r buysell_location, echo = F, warning=F}
# colnames(mrkta_clean)

buysell_locations <- mrkta_clean %>%
  select(fid, country, district.region.code, district.region.name, ward.code, ward.name, village, market.name, 
         `1.location.brought.from`, `2.location.taken.to.`, `gps.coordinates.of.the.market`)

buysell_locations %>% select(market.name,`1.location.brought.from`, `2.location.taken.to.`) %>% head() %>% knitr::kable()

```

