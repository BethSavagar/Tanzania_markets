---
title: "Tanzania Market Survey A: Descriptive Analysis"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)

```

```{r load-data, include = F}

# read in tanzania market data
mrkta <- read_csv(here("tanzania_data/mrkta_generalinfo_tanzania.csv"))
mrktb <- read_csv(here("tanzania_data/mrktb_generalinfo_tanzania.csv"))

## LOOKUPS ##
mrkta_lkpregion <- read_csv(here("ecopprmarketscsvs/mrkta_lkpregion.csv"))
mrkta_lkpward <- read_csv(here("ecopprmarketscsvs/mrkta_lkpward.csv"))

```

## Market Survey A Data: First Look

- Market survey A is the key informant interview

*From the EcoPPR Field Guide:*

- Key informant interview with the market manager or other key person who is knowledgeable about the market, focusing on the general characteristics of the market. (1 survey per market)
- At each market, the field team will identify and arrange to meet with the market manager/person in-charge to introduce the project and obtain permission to collect data, and then conduct a short interview
<br>

### 1) What fields are contained in the survey data?
<br>
```{r clean, echo = F, warning = F}

# mrkta %>% colnames()

## cleaning of colnames
  # rename_with(tolower) %>% # all lowercase
  # rename_with(~gsub("[[:punct:]]", " ", .x)) %>% # replace all punctuation with space " " 
  # rename_with(~gsub("\\s+", ".", .x)) %>% # replace any space with single "."

mrkta_clean <- mrkta %>%
  select(
    fid = `fid.see.mrkta.idtable.`,
    date,
    country = `country.see.mrkta.lkpcountry.`,
    district.region.code = `district.region.see.mrkta.lkpregion.`,
    ward.code = `ward.see.mrkta.lkpward.`,
    village,
    market.name = `name.of.market`,
    market.type = `type.of.market.see.mrkta.lkpmrkt.type.`,
    name.of.respondent,
    `1.location.brought.from` = `1.location.sold.from`, # misleading variable name from cleaning script
    `2.location.taken.to.`,
    `3a.no.sheep.sold.per.day`,
    `3b.no.goats.sold.per.day`,
    `4.seasonal.variation.in.trade`,
    `4.if.yes.describe`,
    `gps.coordinates.of.the.market`,
    `unique.row.identifier.uuid.` 
  ) %>% 
  left_join(mrkta_lkpward %>% select(ward.code = "Code", ward.name = "Description"),
            by = c("ward.code")) %>%
  left_join(mrkta_lkpregion %>% select(Code,"district.region.name" = "Description"),
            by = c(`district.region.code` = "Code")
  )

mrkta_clean <- 
  mrkta_clean %>%
  mutate(
    "market.name" = tolower(`market.name`), # lowercase
    "market.name" = gsub("[[:punct:]]", " ", `market.name`), # remove punctuation
    "market.name" = trimws(`market.name`), #trim leading and trailing spaces
    "market.name" = gsub("\\s+", ".", `market.name`)# replace 1+ spaces with "."
  )  %>% 
  mutate(
    "village" = tolower(`village`), # lowercase
    "village" = gsub("[[:punct:]]", " ", `village`), # remove punctuation
    "village" = trimws(`village`),
    "village" = gsub("\\s+", ".", `village`)
  )
  

# head(mrkta_clean, n = 1) %>% kable()
colnames(mrkta_clean) %>% kable()
```
### 2) How many observations are there?
- How many surveys were completed (i.e. how many markets were visited?)

```{r num_mrkts, echo =F, warning=F}
num_mrkt <- nrow(mrkta_clean)
num_mrkt
```
- How many surveys were completed in each **region**?
  - NB: first 6 regions were those that were targeted...
  - *Why is the number of surveys sp uneven?*

```{r mrkt_region, echo = F, warning = F}

mrktregion_count <- mrkta_clean %>% group_by(district.region.name) %>% count() %>% 
  mutate("target" = ifelse(`district.region.name` %in% c("KATAVI", "SIMIYU", "MBEYA", "MTWARA", "MOROGORO", "DODOMA"), "target","no_target")) %>%
  mutate(target = ordered(target, levels = c("target", "no_target"))) %>%
  arrange(target)

mrktregion_count %>% 
  select(district.region.name, target, n) %>% 
  kable()

ggplot(mrktregion_count, aes(x = district.region.name, y=n))+
  geom_bar(stat = "identity", 
           aes(fill = target,
               #color = target,
               ), alpha = 0.75)+
  #scale_color_brewer(palette = "Set1", direction = -1)+
  scale_fill_brewer(palette = "Set1", direction = -1)+
  labs(x="Region", y = "Number of Surveys", fill = "Target")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))



```
<br>



### 3) Is the market name variable unique, does it correspond to market id variable?
- Are there any duplicated market names in the data?

```{r market-names, include = F}
# Is the market name variable unique, does it correspond to market id variable?
mrkta_clean %>% distinct(fid) # every entry has unique id
mrkta_clean %>% distinct(market.name) # 1 entry is a duplicate: Dutwa
mrkta_clean %>% group_by(market.name) %>% count() %>% view() # identify duplicate markets
# 2 markets appeared twice: Dutwa and Majimoto
duplicate.markets <- mrkta_clean %>% group_by(market.name) %>% count() %>% filter(n>1) %>% pull(market.name)
duplicate.entries <- mrkta_clean %>% 
  filter(market.name %in% duplicate.markets)

mrkta_clean <- mrkta_clean %>%
  mutate(market.name.corrected = ifelse(market.name == "dutwa" & village == "kakola", "dutwa.kakola", 
                                        ifelse(market.name == "dutwa" & village == "igaganulwa", "dutwa.igaganulwa", market.name))) 
```
```{r, echo = F}
kable(duplicate.entries %>% select(date, "district.code"=district.region.code, "district.name"=district.region.name, ward.code, ward.name, village, market.name, name.of.respondent))
```

- Most of the `r num_mrkt` markets are unique... 
- The market names Dutwa and Majimoto each appear twice.
- The market **Dutwa** appears to be an error in the market.name field. Whilst the market name is the same, village, ward name & code, district code and name of respondent is different for the two entries. Suggest correcting the market name to `dutwa.village`: `dutwa.Kakola` and `dutwa.Igaganulwa`
- The market **Majimoto** appears to be a duplicate (2 surveys conducted at the same market). The market name, village, ward name &is  code, district code and name of respondent are the same for both entries. The question answers are different.
- *Add variable "market.name.corrected" with dutwa.kakola and dutwa.igaganulwa as entries*
- See market map below with duplicate locations pinpointed.


### 4) Is the market name always the same as the village name?
- In most cases - yes - the market name is the village name
- Below is a list of markets which have names distinct to the village name (29 examples)
- In some cases the market & village names appear to be the same except for a typo, in others they appear genuinely distinct


```{r market_village, echo = F, warning = F}

# Print entries where market and village names are different: 
mrkt_village_distinct <- mrkta_clean %>% 
  select(village, market.name) %>%
  filter(mrkta_clean$village != mrkta_clean$market.name)

# market name and village are sometimes different, sometimes typos
knitr::kable(mrkt_village_distinct %>% arrange(village))



## SAVE CSVs of CLEAN MARKET & VILLAGE NAMES - for crossreferencing. 

mrkta_mrktname_clean <- mrkta_clean %>% distinct(market.name.corrected)
mrkta_vilname_clean <- mrkta_clean %>% distinct(village)
vilmrktname <- mrkta_clean %>% 
  distinct(village, market.name.corrected) %>% 
  mutate(vilmrktname = str_c(village, market.name.corrected, sep="_"))
# 
# write.csv(mrkta_mrktname_clean, "mrkta_mrktname_clean.csv", row.names = F)
# write.csv(mrkta_vilname_clean, "mrkta_vilname_clean.csv", row.names = F)
# write.csv(vilmrktname, "mrkta_vilmrktname_clean.csv", row.names = F)


```

### 4) How many markets per ward?
- A ward is the administrative level above a village, how many markets were surveyed in each Ward?
- In most wards only one market was surveyed
- Below is a list of wards which have more than one market: Mtandi, Majimoto, Mnavira
- NB: Majitmoto is the repeat market name entry from above

```{r market_ward, echo = F, warning = F}
# markets by WARD:
# Do any wards have more than 1 market?
duplicate.wards <- mrkta_clean %>% 
  group_by(ward.code) %>% 
  count() %>% 
  filter(n>1) %>%
  pull(ward.code) # most wards are unique to 1 market, 3 wards have more than 1 market.

mrkta_clean %>% filter(ward.code %in% duplicate.wards) %>% select(district.region.code, ward.code, ward.name, village, market.name) %>% arrange(ward.name) %>% kable()
```

### 5) What is the type of the markets?
- Market type: 
  - *Primary market* - located close to the place of production or rearing of small ruminants, usually located within villages or small towns.
  - *Secondary market* - usually found in suburbs, animals are transported some distance from their place of production/rearing to the market.
  - *Tertiary or final consumption market* - generally located in towns or populated areas to supply urban populations, animals are transported quite a long-distance from their place of production/rearing.

- All markets are given as Type 1: Primary Markets (note the buyer-seller questionnaire is not consistent with this)

```{r market.type, echo = F}

#####################
# markets by TYPE: 
mrkta_clean %>% 
  group_by(market.type) %>% 
  count() %>% kable() # all markets are type 1

```

## Market Maps:

```{r map_data, include = F}

## MAPPING MARKETS ##

# Load Tanzania Shapefile:
tanzania_shp <- st_read(here("shapefiles/Districts and TC as 2020.shp"))

# Convert mrkt_a to sf for mapping

# GPS coordinates of market are in degrees decimal minutes - DDM (i think)

mrkta_map <- mrkta_clean %>%
  select(fid,
         country,
         district.region.code,
         district.region.name,
         ward.code,
         ward.name,
         village,
         market.name,
         market.name.corrected,
         market.type,
         gps.coordinates.of.the.market,                                 
         unique.row.identifier.uuid.
         ) %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])

mrkta_sf <- st_as_sf(mrkta_map, coords = c("long","lat"),  crs = 4326)
```

```{r prelim-maps, include = F, eval = F}

# plot tanzania districts
ggplot()+
  geom_sf(data=tanzania_shp)+
  coord_sf()+
  theme_bw()

# plot markets on tanzania district map
ggplot() +
  geom_sf(data = tanzania_shp) +
  geom_sf(data = mrkta_sf) +
  coord_sf()+
  theme_bw()

```

### Map of markets colour coded by region
- 6 regions were targeted for surveys
- Regions were targeted purposively as locations where surveys had not previously taken place (not well studied)

Regions Surveyed: 

- NB: this table includes regions where market surveys took place which were not stated as target regions
- Target regions are 1-6

```{r targ_region, echo = F, warning = F}

regions <- data.frame(
  "region" = c(
    "KATAVI",
    "SIMIYU",
    "MBEYA",
    "MTWARA",
    "MOROGOR0",
    "DODOMA",
    "MWANZA",
    "NJOMBE",
    "RUKWA",
    "SONGWE",
    "IRINGA"
  ),
  "target" = c(
    "target",
    "target",
    "target",
    "target",
    "target",
    "target",
    "non_target",
     "non_target",
     "non_target",
     "non_target",
     "non_target"
    ),
  "Location (study site)" = c(
    "West. Mpimbwe district in this region",
    "North. Bariadi is the regional capital.",
    "West/South-West. Mbarali District in this region.",
    "South (South-East). Masasi district in this region",
    "Centre (Centre-East). Ulanga district in this region.",
    "Centre (Centre-East). Bahi district in this region.",
    "North",
    "South (South-West).",
    "East (South-East).",
    "East (South-East).",
    "Centre"
  )
)

regions %>% knitr::kable()
```


```{r tanzania_map, echo = F, warning = F}

# markets by REGION (colour coordinated)
mrktmap_colour <- ggplot() +
  geom_sf(data = tanzania_shp) +
  geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`))) +
  labs(title = "Location of markets, colour by region", col = "District (Region)")+
  # scale_color_brewer(palette = "Set3")+
  coord_sf()+
  theme_bw()

mrktmap_colour
```

### Tanzania Map with *targeted* regions highlighted
- Map of tanzania highlighting regions which were targeted for surveys

```{r region_map_colour, echo = F}

map_col <- brewer.pal(9,"Set1")
map_col[10] <- "#000000"
map_col[11] <- "#FF69B4"
# highlight regions surveyed

districts_surveyed_shp <- tanzania_shp %>%
  # update district names 
  mutate(surveyed = 
           ifelse(NewDist20 == "Mpimbwe DC", "Mpimbwe", 
                  ifelse(NewDist20 == "Bariadi DC", "Bariadi", 
                         ifelse(NewDist20 == "Mbarali DC", "Mbarali",
                                ifelse(NewDist20 == "Masasi DC", "Masasi",
                                       ifelse(NewDist20 == "Ulanga DC", "Ulanga", 
                                              ifelse(NewDist20 == "Bahi DC", "Bahi", NA))))))) %>%
  filter(!is.na(surveyed))


# map with regions surveyed highlighted
region_map <- ggplot()+
  geom_sf(data= tanzania_shp)+
  geom_sf(data= districts_surveyed_shp, aes(fill = surveyed))+
  # labs(title = "Regions targeted for survey")+
  scale_color_manual(palette = map_col)+
  coord_sf()+
  theme_bw()


# map with regions surveyed highlighted and points of market locations superimposed on top
mrkta_sf <- mrkta_sf %>% 
  mutate("target" = ifelse(`district.region.name` %in% c("KATAVI", "SIMIYU", "MBEYA", "MTWARA", "MOROGORO", "DODOMA"), "target","no_target"))

mrktregion_map <- ggplot()+
  geom_sf(data = tanzania_shp, fill = NA)+
  geom_sf(data = districts_surveyed_shp, aes(fill = surveyed), alpha = 0.4)+
  geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`), shape = target))+
  scale_shape_manual(values=c(7,16))+
  # scale_color_brewer(palette = "Set3")+
  coord_sf()+
  labs(col = "District/Region", fill = "Target District")+
  theme_bw()+
  theme(legend.position = "right", legend.direction = "vertical", legend.box = "horizontal", )
# 
# mrktregion_map <- ggplot()+
#   geom_sf(data = tanzania_shp)+
#   geom_sf(data = districts_surveyed_shp, aes(fill = surveyed), alpha = 0.5)+
#   geom_sf(data = mrkta_sf, aes(color = as.factor(`district.region.name`)))+
#   scale_color_manual(palette = map_col)+
#   coord_sf()+
#   labs(col = "District/Region", fill = "Target District")+
#   theme_bw()+
#   theme(legend.direction = "vertical", legend.box = "horizontal")
```
```{r region_map, echo = F}
region_map
```
\newpage

### Regions targeted for market survey + market locations
- Map of Tanzania highlighting regions targeted for survey, and market survey locations (colour coded by region)

```{r mrktregion_map, echo = F}
mrktregion_map
```
\newpage

### Map of location of duplicate markets

- For markets identified as duplicates verify whether they are the same or different locations 
- Majimoto market surveys spatially close together (consistent with being 1 market)
- Dutwa market surveys spaced further apart (consistent with being 2 distinct markets)

```{r duplicates_map, echo = F}
## Check the duplicate market locations

duplicates_mapdata <- duplicate.entries %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])

duplicates_sf <- st_as_sf(duplicates_mapdata, coords = c("long","lat"),  crs = 4326)

duplicates_map <- ggplot() +
  geom_sf(data = tanzania_shp, fill = NA) +
  geom_sf(data = duplicates_sf, aes(shape = as.factor(`district.region.name`), col = as.factor(`market.name`)), size = 2) +
  labs(col = "Market Name",
       shape = "Region")+
  # scale_color_brewer(palette = "Set3")+
  coord_sf()+
  theme_bw()

duplicates_map

```



### Sheep and Goat sales per day
- The total number of sheep and goats sold across all markets
- More goats sold:

```{r tot_sales, echo = F}

# sheep sales per day
# mrkta_clean %>%
#   group_by(`3a.no.sheep.sold.per.day`) %>%
#   count()

sales <- mrkta_clean %>%
  mutate(`3c.all.sold.per.day` = `3a.no.sheep.sold.per.day`+`3b.no.goats.sold.per.day`) %>%
  select(fid, district.region.code, district.region.name, sales = `3c.all.sold.per.day`) %>% mutate(sp = "All") %>%
  rbind(mrkta_clean %>%
  select(fid, district.region.code, district.region.name, sales = `3a.no.sheep.sold.per.day`) %>%
  mutate(sp = "Sheep")) %>%
  rbind(mrkta_clean %>%
    select(fid, district.region.code, district.region.name, sales = `3b.no.goats.sold.per.day`) %>%
  mutate(sp = "Goat"))

# total reported sheep and goat sales per day of market
tot.sales <- sales %>% 
  group_by(sp) %>%
  summarise(tot = sum(sales)) %>%
  rename(Species = sp,
         Total_Sales = tot)

kable(tot.sales)
```

### Reported total sales of sheep and goats per day at surveyed markets
<br>
```{r sales_per_day, echo = F, fig.width = 4, fig.height = 4}
SR_sales_per_day <- ggplot(sales %>% filter(sp=="All"))+
  geom_histogram(aes(x=sales), binwidth = 25, alpha = 0.5, col = "black", boundary = 0)+
  scale_x_continuous(breaks = seq(0,650,50), labels = seq(0,650,50))+
  labs(x = "All Small Ruminant Sales per Day", 
       y = "Count",
       main = "All Small Ruminant Sales per Day")+
  # facet_wrap(~sp)
  theme_bw()

sales_per_day <- ggplot(sales %>% filter(sp %in% c("Sheep", "Goat")))+
  geom_histogram(aes(x=sales,col=sp, fill = sp), binwidth = 25, alpha = 0.5, position = position_dodge(), boundary = 0)+
  scale_x_continuous(breaks = seq(0,400,50), labels = seq(0,400,50))+
  labs(x = "Sheep & Goat Sales per Day", 
       y = "Count",
       fill = "Species", 
       col = "Species",
       main = "Sheep and Goat Sales per Day")+
  # facet_wrap(~sp)
  theme_bw()


shgt_scatter <- ggplot(mrkta_clean, aes(x = `3a.no.sheep.sold.per.day`, 
                                       y = `3b.no.goats.sold.per.day` ))+
  geom_point()+
  labs(x = "Sheep sales per day",
       y = "Goat sales per day")+
  theme_bw()

sales_arr <- ggarrange(SR_sales_per_day,
sales_per_day,
shgt_scatter, ncol = 1)

```
<br>
<br>

### Reported total sales of sheep and goats per day at surveyed markets: BY REGION

```{r regional_sales, echo = F, fig.width = 4, fig.height = 4}
SR_sales_per_day_rg <- ggplot(sales %>% filter(sp=="All"))+
  geom_histogram(aes(x=sales), binwidth = 25, alpha = 0.5, col = "black", boundary = 0)+
  scale_x_continuous(breaks = seq(0,650,50), labels = seq(0,650,50))+
  labs(x = "All Small Ruminant Sales per Day", 
       y = "Count",
       main = "All Small Ruminant Sales per Day")+
  facet_wrap(~`district.region.name`)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))


sales_per_day_rg <- ggplot(sales %>% filter(sp %in% c("Sheep", "Goat")))+
  geom_histogram(aes(x=sales,col=sp, fill = sp), binwidth = 25, alpha = 0.5, position = position_dodge(), boundary = 0)+
  scale_x_continuous(breaks = seq(0,400,50), labels = seq(0,400,50))+
  labs(x = "Sheep & Goat Sales per Day", 
       y = "Count",
       fill = "Species", 
       col = "Species",
       main = "Sheep and Goat Sales per Day")+
  # facet_wrap(~sp)
  facet_wrap(~`district.region.name`)+
  theme_bw()+
    theme(axis.text.x = element_text(angle = -45, vjust=0, hjust=0))


shgt_scatter_rg <- ggplot(mrkta_clean, aes(x = `3a.no.sheep.sold.per.day`, 
                                       y = `3b.no.goats.sold.per.day` ))+
  geom_point()+
  labs(x = "Sheep sales per day",
       y = "Goat sales per day")+
  facet_wrap(~`district.region.name`)+
  theme_bw()

ggarrange(SR_sales_per_day_rg,
sales_per_day_rg,
shgt_scatter_rg, ncol = 1)

```







*Small Ruminant Sales interpretation*
- ....

### Is there seasonal variation in trade?

```{r seasonal_trade, echo = F}

mrkta_clean %>% 
  group_by(`4.seasonal.variation.in.trade`) %>%
  count() %>%
  mutate(
    YN = ifelse(`4.seasonal.variation.in.trade` == 0, "N", "Y"),
    proportion = n/nrow(mrkta_clean)) %>% 
  select(`4.seasonal.variation.in.trade`, YN, n, proportion) %>%
  kable()
```


For those which state seasonal variation what details are provided?
- *Translate the below*
```{r seasonal_trade_ans, echo = F, warning = F}
# translate this: 
mrkta_clean %>% select(`4.seasonal.variation.in.trade`, `4.if.yes.describe`) %>% head() %>% kable()
```

### What does the market A data look like for locations brought from and to?

```{r buysell_location, echo = F, warning=F}
# colnames(mrkta_clean)

buysell_locations <- mrkta_clean %>%
  select(fid, country, district.region.code, district.region.name, ward.code, ward.name, village, market.name, 
         `1.location.brought.from`, `2.location.taken.to.`, `gps.coordinates.of.the.market`)

buysell_locations %>% select(market.name,`1.location.brought.from`, `2.location.taken.to.`) %>% head() %>% knitr::kable()

```

